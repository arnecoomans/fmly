{% extends 'index.html' %}
{% load static %}
{% block content %}
  {% if not perms.archive.view_person %}
    {% include  'archive/snippets/error_no_access.html' with object_type='people' %}
  {% elif person.is_deleted %}
    {% include  'archive/snippets/error_object_deleted.html' with object_type='person' %}
  {% else %}
    <section class="person" id="person-{{ person.slug }}">
      <header>
        <h1>{{ person.full_name }}:</h1>
        <h6>{{ person.get_lifespan_display }}</h6>
        <!-- Legacy Action List-->
        {% if perms.archive.change_person %}
          <ul class="action list no-bullets text-end">
            <li><a href="{% url 'archive:person-edit' person.id %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'edit'|capfirst %} {% translate 'person details' %}"><svg class="bi" width="16" height="16" fill="currentColor"><use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#pencil"/></svg></a></li>
          {% if perms.archive.add_document or perms.archive.add_image %}
              <li><A href="{% url 'archive:add-person-image' person.id person.slug %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'add image for'|capfirst %} {{ person.full_name }}"><svg class="bi" width="16" height="16" fill="currentColor"><use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#file-earmark-plus"/></svg></a></li>
            {% endif %}
            {% if user.is_staff %}<li><a href="/admin/archive/person/{{ person.id }}/change/" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'edit'|capfirst %} {% translate 'image' %} {% translate 'in admin' %}"><svg class="bi" width="16" height="16" fill="currentColor"><use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#pencil-square"/></svg></a></li>{% endif %}
          </ul>
        {% endif %}
      </header>
      <div class="container person-profile py-3">
        <div class="row align-items-start">
          <!-- IMAGE COLUMN -->
          <div class="col-md-4 text-center mb-3 mb-md-0" id="portrait">
            {% include 'field/person_portrait.html' with person=person %}
          </div>

          <!-- CONTENT COLUMN -->
          <div class="col-md-8">
            <div id="bio">
              {% include 'field/person_bio.html' with person=person %}
            </div>
            <div id="names">
              {% include 'function/person_names.html' with person=person %}
            </div>
            <div id="dates">
              {% include 'function/person_dates.html' with person=person %}
            </div>
            <div id="family">
              {% include 'function/person_family.html' with person=person %}
            </div>
            {% if not person.private %}
            <div id="family-tree">
              <div class="d-flex">
                <div class="flex-grow-1">
                  <div class="d-flex py-1">
                    <div class="col-4 col-sm-3 text-muted small text-uppercase fw-semibold">{% translate 'family tree'|capfirst %}:</div>
                    <div class="col">
                      <a href="{% url 'archive:tree' person.id %}">{% translate 'See family tree of'%} {{ person.full_name }}</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          </div>
        </div>
      </div>
    </section>

    <section id="related-data" class="mt-4">
      <!-- Related data -->
      {% if not person.private and person.images.all.count > 0 %}
        <a name="images"></a>
        <h3>{{ count_images }} {% blocktranslate count counter=count_images %}Image{% plural %}Images{% endblocktranslate %} {% translate 'with' %} {{ person.full_name }}:</h3>
        {% include 'archive/snippets/toggle_hidden_images.html' %}
        <!-- Pagination -->
        {% include 'archive/snippets/pagination.html' with focus='images' %}
        <div class="objects">
          {% for object in image_list.all %}
            {% include 'archive/snippets/image.html' %}
          {% endfor %}
        </div>
        <!-- Pagination -->
        {% include 'archive/snippets/pagination.html' %}
      {% endif %}
      <div class="clearfix"></div>
    </section>
  {% endif %}
{% endblock %}




{% block scriptfooter %}
<script type="module">
document.addEventListener('DOMContentLoaded', () => {
  console.debug('[relation-helper] ready (robust binding)');

  function bindRelationForms(root = document) {
    root.querySelectorAll('form[data-relation-form]').forEach(form => {
      if (form.dataset.relationBound === '1') return;
      form.dataset.relationBound = '1';

      const select = form.querySelector('select[name=relation_type]');
      const hiddenPerson = form.querySelector('input[name=person_id]');
      const submitBtn = form.querySelector('[type=submit]');

      // defer the binding until id field exists
      function waitForTargetInput() {
        const hiddenTarget = form.querySelector('input[type=hidden][name=id]');
        if (!hiddenTarget) {
          console.debug('[relation-helper] waiting for autosuggest hidden id...');
          setTimeout(waitForTargetInput, 100);
          return;
        }
        console.debug('[relation-helper] found hidden target', hiddenTarget);
        setup(form, select, hiddenPerson, hiddenTarget, submitBtn);
      }
      waitForTargetInput();
    });
  }

  function setup(form, select, hiddenPerson, hiddenTarget, submitBtn) {
    function buildPayload() {
      const relationType = select.value;
      const personId = hiddenPerson?.value?.trim() || null;
      const targetId = hiddenTarget?.value?.trim() || null;
      if (!relationType || !targetId) return null;

      const payload = { relation: null, up__id: null, down__id: null };

      if (relationType === 'parent') {
        payload.type = 'parent';
        payload.up__id = targetId;
        payload.down__id = personId;
      } else if (relationType === 'child') {
        payload.type = 'parent';
        payload.up__id = personId;
        payload.down__id = targetId;
      } else if (relationType === 'partner') {
        payload.type = 'partner';
        payload.up__id = personId;
        payload.down__id = targetId;
      }

      form.dataset.body = JSON.stringify(payload);
      console.debug('[relation-helper] attached payload', payload);

      submitBtn.disabled = !(targetId && relationType);
      return payload;
    }

    form.addEventListener('cmnsd:autosuggest:selected', () => setTimeout(buildPayload, 50));
    select.addEventListener('change', buildPayload);
    form.addEventListener('submit', e => {
      const payload = buildPayload();
      if (!payload) {
        e.preventDefault();
        console.warn('[relation-helper] blocked submit — no valid payload');
        return false;
      }
      console.debug('[relation-helper] final JSON payload', payload);
    });

    buildPayload();
    console.debug('[relation-helper] bound successfully', form);
  }

  bindRelationForms();

  document.addEventListener('cmnsd:content:applied', e => {
    bindRelationForms(e.detail?.container || document);
  });
});
</script>

<script>
function initCropper(root = document) {
    const wrapper = root.querySelector("#crop-wrapper");
    if (!wrapper) return;

    console.debug("[crop] initialising cropper in", wrapper);

    const img = wrapper.querySelector("#crop-image");
    const rect = wrapper.querySelector("#crop-rect");
    const shade = wrapper.querySelector("#crop-shade");
    const saveBtn = root.querySelector("#crop-save-btn");

    if (!img || !rect || !shade || !saveBtn) {
        console.warn("[crop] missing elements — skipping init");
        return;
    }

    let naturalW = 0, naturalH = 0;
    let dragging = false;
    let resizing = false;
    let resizingHandle = null;
    let startX = 0, startY = 0;

    img.addEventListener("load", () => {
        naturalW = img.naturalWidth;
        naturalH = img.naturalHeight;
        console.debug("[crop] natural size =", naturalW, naturalH);
    });

    function updateShade() {
        const wRect = wrapper.getBoundingClientRect();
        const rRect = rect.getBoundingClientRect();

        const top    = rRect.top    - wRect.top;
        const left   = rRect.left   - wRect.left;
        const bottom = rRect.bottom - wRect.top;
        const right  = rRect.right  - wRect.left;

        shade.style.clipPath = `
          polygon(
            0% 0%, 100% 0%, 100% 100%, 0% 100%,
            0% ${top}px,
            ${left}px ${top}px,
            ${left}px ${bottom}px,
            ${right}px ${bottom}px,
            ${right}px ${top}px,
            0% ${top}px
          )
        `;
    }

    function finalizeCrop() {
        const wRect = wrapper.getBoundingClientRect();
        const rRect = rect.getBoundingClientRect();

        if (rRect.width <= 0 || rRect.height <= 0) return;

        if (!naturalW || !naturalH) {
            naturalW = img.naturalWidth;
            naturalH = img.naturalHeight;
        }

        const scaleX = naturalW / wRect.width;
        const scaleY = naturalH / wRect.height;

        const crop = {
            portrait_x: Math.round((rRect.left - wRect.left) * scaleX),
            portrait_y: Math.round((rRect.top  - wRect.top)  * scaleY),
            portrait_w: Math.round(rRect.width  * scaleX),
            portrait_h: Math.round(rRect.height * scaleY),
        };

        console.debug("[crop] final crop =", crop);

        saveBtn.dataset.body = JSON.stringify(crop);
        saveBtn.disabled = false;
    }

    wrapper.addEventListener("mousedown", (e) => {
        if (e.target.classList.contains("crop-handle")) {
            resizing = true;
            resizingHandle = e.target;
            e.preventDefault();
            return;
        }

        const box = wrapper.getBoundingClientRect();
        dragging = true;
        resizing = false;
        resizingHandle = null;

        startX = e.clientX - box.left;
        startY = e.clientY - box.top;

        rect.style.left = `${startX}px`;
        rect.style.top = `${startY}px`;
        rect.style.width = "0px";
        rect.style.height = "0px";
        rect.style.display = "block";

        updateShade();
        saveBtn.disabled = true;
    });

    document.addEventListener("mousemove", (e) => {
        if (!dragging && !resizing) return;

        const box = wrapper.getBoundingClientRect();
        const pointerX = e.clientX - box.left;
        const pointerY = e.clientY - box.top;

        if (dragging) {
            const left = Math.min(startX, pointerX);
            const top  = Math.min(startY, pointerY);
            const w    = Math.abs(pointerX - startX);
            const h    = Math.abs(pointerY - startY);

            rect.style.left = `${left}px`;
            rect.style.top = `${top}px`;
            rect.style.width = `${w}px`;
            rect.style.height = `${h}px`;
        }

        if (resizing && resizingHandle) {
            const rRect = rect.getBoundingClientRect();
            const wRect = wrapper.getBoundingClientRect();

            let left = rRect.left - wRect.left;
            let top  = rRect.top  - wRect.top;
            let width  = rRect.width;
            let height = rRect.height;

            const cls = resizingHandle.classList;

            if (cls.contains("nw")) {
                width  += left - pointerX;
                height += top  - pointerY;
                left = pointerX;
                top  = pointerY;
            }
            if (cls.contains("ne")) {
                width  = pointerX - left;
                height += top - pointerY;
                top = pointerY;
            }
            if (cls.contains("sw")) {
                width  += left - pointerX;
                left = pointerX;
                height = pointerY - top;
            }
            if (cls.contains("se")) {
                width  = pointerX - left;
                height = pointerY - top;
            }

            left   = Math.max(0, Math.min(left, wRect.width - width));
            top    = Math.max(0, Math.min(top,  wRect.height - height));
            width  = Math.max(1, Math.min(width,  wRect.width - left));
            height = Math.max(1, Math.min(height, wRect.height - top));

            rect.style.left   = `${left}px`;
            rect.style.top    = `${top}px`;
            rect.style.width  = `${width}px`;
            rect.style.height = `${height}px`;
        }

        updateShade();
    });

    document.addEventListener("mouseup", () => {
        if (!dragging && !resizing) return;
        dragging = false;
        resizing = false;
        resizingHandle = null;

        finalizeCrop();
    });

    console.debug("[crop] initialized");
}

/*** RUN ON PAGE LOAD ***/
document.addEventListener("DOMContentLoaded", () => {
    initCropper();
});

/*** RUN AFTER CMNSD AJAX LOAD ***/
document.addEventListener("cmnsd:content:applied", (e) => {
    initCropper(e.detail?.container || document);
});
</script>
{% endblock %}