{% extends 'index.html' %}
{% load static %}
{% block content %}
  {% if not perms.archive.view_person %}
    {% include  'archive/snippets/error_no_access.html' with object_type='people' %}
  {% elif person.is_deleted %}
    {% include  'archive/snippets/error_object_deleted.html' with object_type='person' %}
  {% else %}
    <section class="person" id="person-{{ person.slug }}">
      <header>
        <h1>{{ person.full_name }}:</h1>
        <h6>{{ person.get_lifespan_display }}</h6>
        <!-- Legacy Action List-->
        {% if perms.archive.change_person %}
          <ul class="action list no-bullets text-end">
            <li><a href="{% url 'archive:person-edit' person.id %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'edit'|capfirst %} {% translate 'person details' %}"><svg class="bi" width="16" height="16" fill="currentColor"><use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#pencil"/></svg></a></li>
          {% if perms.archive.add_document or perms.archive.add_image %}
              <li><A href="{% url 'archive:add-person-image' person.id person.slug %}" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'add image for'|capfirst %} {{ person.full_name }}"><svg class="bi" width="16" height="16" fill="currentColor"><use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#file-earmark-plus"/></svg></a></li>
            {% endif %}
            {% if user.is_staff %}<li><a href="/admin/archive/person/{{ person.id }}/change/" data-bs-toggle="tooltip" data-bs-placement="top" title="{% translate 'edit'|capfirst %} {% translate 'image' %} {% translate 'in admin' %}"><svg class="bi" width="16" height="16" fill="currentColor"><use xlink:href="{% static 'bootstrap-icons/bootstrap-icons.svg' %}#pencil-square"/></svg></a></li>{% endif %}
          </ul>
        {% endif %}
      </header>
      <div class="container person-profile py-3">
        <div class="row align-items-start">
          <!-- IMAGE COLUMN -->
          <div class="col-md-4 text-center mb-3 mb-md-0">
            {% if person.portrait %}
              <a href="{% url 'archive:image-redirect' person.portrait.id %}">
                <img src="/documents/{{ person.portrait.source }}"
                      alt="{% translate 'portrait of'|capfirst %} {{ person.full_name }}"
                      class="img-fluid rounded shadow-sm profile-photo">
              </a>
            {% else %}
              <div class="bg-light border text-muted rounded p-5">No photo</div>
            {% endif %}
          </div>

          <!-- CONTENT COLUMN -->
          <div class="col-md-8">
            <div id="bio">
              {% include 'field/person_bio.html' with person=person %}
            </div>
            <div id="names">
              {% include 'function/person_names.html' with person=person %}
            </div>
            <div id="dates">
              {% include 'function/person_dates.html' with person=person %}
            </div>
            <div id="family">
              {% include 'function/person_family.html' with person=person %}
            </div>
            {% if not person.private %}
            <div id="family-tree">
              <div class="d-flex">
                <div class="flex-grow-1">
                  <div class="d-flex py-1">
                    <div class="col-4 col-sm-3 text-muted small text-uppercase fw-semibold">{% translate 'family tree'|capfirst %}:</div>
                    <div class="col">
                      <a href="{% url 'archive:tree' person.id %}">{% translate 'See family tree of'%} {{ person.full_name }}</a>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          {% endif %}
          </div>
        </div>
      </div>
    </section>

    <section id="related-data" class="mt-4">
      <!-- Related data -->
      {% if not person.private and person.images.all.count > 0 %}
        <a name="images"></a>
        <h3>{{ count_images }} {% blocktranslate count counter=count_images %}Image{% plural %}Images{% endblocktranslate %} {% translate 'with' %} {{ person.full_name }}:</h3>
        {% include 'archive/snippets/toggle_hidden_images.html' %}
        <!-- Pagination -->
        {% include 'archive/snippets/pagination.html' with focus='images' %}
        <div class="objects">
          {% for object in image_list.all %}
            {% include 'archive/snippets/image.html' %}
          {% endfor %}
        </div>
        <!-- Pagination -->
        {% include 'archive/snippets/pagination.html' %}
      {% endif %}
      <div class="clearfix"></div>
    </section>
  {% endif %}
{% endblock %}




{% block scriptfooter %}
<script type="module">
document.addEventListener('DOMContentLoaded', () => {
  console.debug('[relation-helper] ready (robust binding)');

  function bindRelationForms(root = document) {
    root.querySelectorAll('form[data-relation-form]').forEach(form => {
      if (form.dataset.relationBound === '1') return;
      form.dataset.relationBound = '1';

      const select = form.querySelector('select[name=relation_type]');
      const hiddenPerson = form.querySelector('input[name=person_id]');
      const submitBtn = form.querySelector('[type=submit]');

      // defer the binding until id field exists
      function waitForTargetInput() {
        const hiddenTarget = form.querySelector('input[type=hidden][name=id]');
        if (!hiddenTarget) {
          console.debug('[relation-helper] waiting for autosuggest hidden id...');
          setTimeout(waitForTargetInput, 100);
          return;
        }
        console.debug('[relation-helper] found hidden target', hiddenTarget);
        setup(form, select, hiddenPerson, hiddenTarget, submitBtn);
      }
      waitForTargetInput();
    });
  }

  function setup(form, select, hiddenPerson, hiddenTarget, submitBtn) {
    function buildPayload() {
      const relationType = select.value;
      const personId = hiddenPerson?.value?.trim() || null;
      const targetId = hiddenTarget?.value?.trim() || null;
      if (!relationType || !targetId) return null;

      const payload = { relation: null, up__id: null, down__id: null };

      if (relationType === 'parent') {
        payload.type = 'parent';
        payload.up__id = targetId;
        payload.down__id = personId;
      } else if (relationType === 'child') {
        payload.type = 'parent';
        payload.up__id = personId;
        payload.down__id = targetId;
      } else if (relationType === 'partner') {
        payload.type = 'partner';
        payload.up__id = personId;
        payload.down__id = targetId;
      }

      form.dataset.body = JSON.stringify(payload);
      console.debug('[relation-helper] attached payload', payload);

      submitBtn.disabled = !(targetId && relationType);
      return payload;
    }

    form.addEventListener('cmnsd:autosuggest:selected', () => setTimeout(buildPayload, 50));
    select.addEventListener('change', buildPayload);
    form.addEventListener('submit', e => {
      const payload = buildPayload();
      if (!payload) {
        e.preventDefault();
        console.warn('[relation-helper] blocked submit â€” no valid payload');
        return false;
      }
      console.debug('[relation-helper] final JSON payload', payload);
    });

    buildPayload();
    console.debug('[relation-helper] bound successfully', form);
  }

  bindRelationForms();

  document.addEventListener('cmnsd:content:applied', e => {
    bindRelationForms(e.detail?.container || document);
  });
});
</script>
{% endblock %}